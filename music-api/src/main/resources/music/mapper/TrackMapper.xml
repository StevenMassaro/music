<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="music.mapper.TrackMapper">

    <select id="list" resultMap="trackResultMap">
        <include refid="selectColumns"/>
        WHERE deletedInd != true
        <include refid="selectGroupBy"/>
        ORDER BY artist,album,disc_no,track
    </select>

    <select id="listAll" resultMap="trackResultMap">
        <include refid="selectColumns"/>
        <include refid="selectGroupBy"/>
        ORDER BY artist,album,disc_no,track
    </select>

    <sql id="selectColumns">
        SELECT
        t.id
        , t.title
        , t."location"
        , t.hash
        , t.album
        , t.artist
        , t.album_artist
        , t.genre
        , t."year"
        , t.disc_no
        , t.track
        , t.rating
        , t."comment"
        , t.deletedind
        , t.bitrate
        , t.encoding
        , t.sampleRate
        , t.duration
        , t.datecreated
        , t.dateupdated
        , t.filelastmodifieddate
        , COUNT(p.playdate) + COALESCE(pc.playcount, 0) - (SELECT COUNT(*) FROM music.plays WHERE songid = t.id AND imported = true) AS plays
        FROM music.track t
        LEFT OUTER JOIN music.plays p
        ON p.songid = t.id
        LEFT OUTER JOIN music.playcount pc
        ON pc.songid = t.id
    </sql>

    <sql id="selectGroupBy">
        GROUP BY
        t.id
        , t.title
        , t."location"
        , t.hash
        , t.album
        , t.artist
        , t.album_artist
        , t.genre
        , t."year"
        , t.disc_no
        , t.track
        , t.rating
        , t."comment"
        , t.deletedind
        , t.bitrate
        , t.encoding
        , t.sampleRate
        , t.duration
        , t.datecreated
        , t.dateupdated
        , t.filelastmodifieddate
        , pc.playcount
    </sql>

    <select id="get" resultMap="trackResultMap">
        <include refid="selectColumns"/>
        WHERE t.id = #{id}
        <include refid="selectGroupBy"/>
    </select>

    <select id="getByLocation" resultMap="trackResultMap">
        <include refid="selectColumns"/>
        WHERE t.location = #{location}
        <include refid="selectGroupBy"/>
    </select>

    <delete id="deleteById">
        DELETE FROM music.track t WHERE t.id = #{id}
    </delete>

    <update id="markDeletedById">
        UPDATE music.track SET deletedInd = #{deletedInd} WHERE id = #{id}
    </update>

    <resultMap id="trackResultMap" type="music.model.Track">
        <id property="id" column="id"/>
    </resultMap>

    <insert id="insert">
        INSERT INTO music.track (title, location, hash, album, artist, album_artist, genre, "year", disc_no, track,
        rating, comment, deletedInd, bitrate, encoding, sampleRate, duration, fileLastModifiedDate)
        VALUES(#{track.title}, #{track.location}, #{track.hash}, #{track.album}, #{track.artist}, #{track.album_artist},
        #{track.genre}, #{track.year}, #{track.disc_no}, #{track.track}, #{track.rating}, #{track.comment}, #{track.deletedInd},
        #{track.bitrate}, #{track.encoding}, #{track.sampleRate}, #{track.duration}, #{track.fileLastModifiedDate})
    </insert>

    <update id="updateByLocation">
        UPDATE music.track
        SET
        title = #{track.title},
        hash = #{track.hash},
        album = #{track.album},
        artist = #{track.artist},
        album_artist = #{track.album_artist},
        genre = #{track.genre},
        "year" = #{track.year},
        disc_no = #{track.disc_no},
        track = #{track.track},
        comment = #{track.comment},
        bitrate = #{track.bitrate},
        encoding = #{track.encoding},
        sampleRate = #{track.sampleRate},
        duration = #{track.duration},
        fileLastModifiedDate = #{track.fileLastModifiedDate},
        dateUpdated = #{track.dateUpdated}
        WHERE location = #{track.location}
    </update>

    <update id="setRatingById">
        UPDATE music.track
        SET rating = #{rating}
        WHERE id = #{id}
    </update>
</mapper>
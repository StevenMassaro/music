<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="music.mapper.TrackMapper">

    <select id="list" resultMap="trackResultMap">
		<include refid="listSql"></include>
    </select>

    <select id="listByLibraryId" resultMap="trackResultMap">
		<include refid="selectColumns"/>
		WHERE deletedInd != true
		<if test="libraryId != null">
			AND libraryId = #{libraryId}
		</if>
		ORDER BY artist,album,disc_no,track
    </select>

    <select id="listDeleted" resultMap="trackResultMap">
        <include refid="selectColumns"/>
		WHERE deletedInd = true
        ORDER BY artist,album,disc_no,track
    </select>

    <select id="listDeletedByLibraryId" resultMap="trackResultMap">
        <include refid="selectColumns"/>
		WHERE deletedInd = true
		<if test="libraryId != null">
			AND libraryId = #{libraryId}
		</if>
        ORDER BY artist,album,disc_no,track
    </select>

	<select id="listWithSmartPlaylist" resultMap="trackResultMap">
		SELECT * FROM (<include refid="listSql"></include>) as tracks
		WHERE ${dynamicSql}
	</select>

	<select id="listWithPlaylist" resultMap="trackResultMap">
		SELECT tracks.* FROM (<include refid="listSql"></include>) AS tracks
		INNER JOIN music.playlisttrack pt ON pt.trackid = tracks.trackId
		WHERE tracks.trackId IN (SELECT trackId FROM music.playlisttrack pt WHERE pt.playlistId = #{playlistId})
		ORDER BY pt.sequenceid
	</select>

	<sql id="listSql">
		<include refid="selectColumns"/>
		WHERE deletedInd != true
		ORDER BY artist,album,disc_no,track
	</sql>

	<select id="countPurgableTracks" resultType="long">
		SELECT COUNT(*)
		<include refid="selectJoin"></include>
		WHERE deletedInd = true
	</select>

	<select id="listPurgableTracks" resultMap="trackResultMap">
		<include refid="selectColumns"/>
		WHERE deletedInd = true
	</select>

	<select id="listPlaysByDate" resultMap="trackResultMap">
		<include refid="selectColumns"/>
		LEFT OUTER JOIN music.plays p
		ON p.songid = t.id
		WHERE date_trunc('day', p.playdate) = #{date}
		ORDER BY p.playdate DESC
	</select>

	<select id="listByAlbum" resultMap="trackResultMap">
		<include refid="selectColumns"/>
		WHERE t.album = #{album}
		AND t.artist = #{artist}
		<if test="disc == null">
			AND t.disc_no IS NULL
		</if>
		<if test="disc != null">
			AND t.disc_no = #{disc}
		</if>
	</select>

	<select id="listHistoricalDates" resultType="java.util.Date">
		SELECT DISTINCT
		date_trunc('day', p.playdate) AS playdategroup
		FROM music.plays p
		ORDER BY playdategroup DESC
	</select>

    <sql id="selectColumns">
        SELECT
		t.id as trackId
        , t.title
        , t."location"
        , t.hash
        , t.album
        , t.artist
        , t.album_artist
        , t.genre
        , t."year"
        , t.disc_no
        , t.track
        , t.rating
        , t."comment"
        , t.deletedind
        , t.bitrate
        , t.encoding
        , t.sampleRate
        , t.duration
        , t.datecreated
        , t.dateupdated
        , t.filelastmodifieddate
    	, (
			SELECT max(p.playdate)
			FROM music.plays p
			WHERE p.songid = t.id
		) AS lastplayeddate
		, l.id as libraryId
		, l.name as libraryName
		, l.subfolder as librarySubFolder
		,
		(
		    SELECT Count(p.playdate)
				   + COALESCE(pc.playcount, 0) - (SELECT Count(*)
												  FROM   music.plays
												  WHERE  songid = t.id
														 AND imported = true)
			FROM   music.plays p
				   LEFT OUTER JOIN music.playcount pc
								ON pc.songid = t.id
			WHERE  p.songid = t.id
			GROUP  BY pc.playcount
		) AS plays,
       (
           SELECT Count(s.skipdate)
				   + COALESCE(sc.skipcount, 0) - (SELECT Count(*)
												  FROM   music.skips
												  WHERE  songid = t.id
														 AND imported = true)
			FROM   music.skips s
				   LEFT OUTER JOIN music.skipcount sc
								ON sc.songid = t.id
			WHERE  s.songid = t.id
			GROUP  BY sc.skipcount
	   ) AS skips
		<include refid="selectJoin"></include>
    </sql>

	<sql id="selectJoin">
		FROM music.track t
		INNER JOIN music.library l ON t.libraryId = l.id
	</sql>

    <select id="get" resultMap="trackResultMap">
        <include refid="selectColumns"/>
        WHERE t.id = #{id}
    </select>

    <select id="getByLocationAndLibrary" resultMap="trackResultMap">
        <include refid="selectColumns"/>
        WHERE t.location = #{location} AND t.libraryId = #{libraryId}
    </select>

	<select id="getByTitleArtistAlbum" resultMap="trackResultMap">
		<include refid="selectColumns"/>
		WHERE t.title = #{title} AND
		t.album = #{album} AND
		t.artist = #{artist}
	</select>

    <delete id="deleteById">
        DELETE FROM music.track t WHERE t.id = #{id}
    </delete>

    <update id="markDeletedById">
        UPDATE music.track SET deletedInd = #{deletedInd} WHERE id = #{id}
    </update>

    <resultMap id="trackResultMap" type="music.model.Track" autoMapping="true">
		<id property="id" column="trackId"/>
		<association property="library" resultMap="libraryResultMap"/>
    </resultMap>

	<resultMap id="libraryResultMap" type="music.model.Library">
		<id property="id" column="libraryId" javaType="_long"/>
		<result property="subfolder" column="librarySubFolder" javaType="String"/>
		<result property="name" column="libraryName" javaType="String"/>
	</resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="track.id" keyColumn="id">
        INSERT INTO music.track (title, location, hash, album, artist, album_artist, genre, "year", disc_no, track,
        rating, comment, deletedInd, bitrate, encoding, sampleRate, duration, fileLastModifiedDate, libraryId)
        VALUES(#{track.title}, #{track.location}, #{track.hash}, #{track.album}, #{track.artist}, #{track.album_artist},
        #{track.genre}, #{track.year}, #{track.disc_no}, #{track.track}, #{track.rating}, #{track.comment}, #{track.deletedInd},
        #{track.bitrate}, #{track.encoding}, #{track.sampleRate}, #{track.duration}, #{track.fileLastModifiedDate}, #{track.library.id})
    </insert>

    <update id="update">
        UPDATE music.track
        SET
        title = #{track.title},
        hash = #{track.hash},
        album = #{track.album},
        artist = #{track.artist},
        album_artist = #{track.album_artist},
        genre = #{track.genre},
        "year" = #{track.year},
        disc_no = #{track.disc_no},
        track = #{track.track},
        comment = #{track.comment},
        bitrate = #{track.bitrate},
        encoding = #{track.encoding},
        sampleRate = #{track.sampleRate},
        duration = #{track.duration},
        fileLastModifiedDate = #{track.fileLastModifiedDate},
        dateUpdated = #{track.dateUpdated}
        WHERE id = #{track.id}
    </update>

    <update id="setRatingById">
        UPDATE music.track
        SET rating = #{rating}
        WHERE id = #{id}
    </update>

	<update id="updateFieldById">
		UPDATE music.track
		SET ${field} = CAST(#{newValue} AS ${type})
		WHERE id = #{id}
	</update>
</mapper>
